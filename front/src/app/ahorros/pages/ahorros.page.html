<div class="savings-container">
  <!-- Header -->
  <div class="savings-header">
    <h1>
      <mat-icon>savings</mat-icon>
      Ahorros
    </h1>
    <p>Gestiona tus ahorros y metas financieras</p>
  </div>

  <!-- Message Display -->
  <div class="message-container" *ngIf="showMessageFlag">
    <div class="message-alert">
      {{ message }}
    </div>
  </div>

  <!-- Savings Form -->
  <mat-card class="savings-form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>add_circle</mat-icon>
        {{ editingId ? 'Editar Ahorro' : 'Agregar Nuevo Ahorro' }}
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="savingsForm" (ngSubmit)="onSubmit()">
        <!-- First Row -->
        <div class="form-row">
          <mat-form-field class="form-field" appearance="outline">
            <mat-label>Monto</mat-label>
            <input
              matInput
              type="number"
              step="0.01"
              min="0"
              formControlName="amount"
              placeholder="0.00" />
            <span matPrefix>$&nbsp;</span>
            <mat-error *ngIf="getFieldError('amount')">
              {{ getFieldError('amount') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field class="form-field" appearance="outline">
            <mat-label>Categoría</mat-label>
            <mat-select formControlName="category">
              <mat-option *ngFor="let category of savingsCategories" [value]="category.value">
                <mat-icon>{{ category.icon }}</mat-icon>
                {{ category.label }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="getFieldError('category')">
              {{ getFieldError('category') }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Second Row -->
        <div class="form-row">
          <mat-form-field class="form-field" appearance="outline">
            <mat-label>Descripción</mat-label>
            <input
              matInput
              formControlName="description"
              placeholder="Describe el propósito del ahorro"
              maxlength="500" />
            <mat-error *ngIf="getFieldError('description')">
              {{ getFieldError('description') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field class="form-field" appearance="outline">
            <mat-label>Fecha</mat-label>
            <input matInput [matDatepicker]="datePicker" formControlName="date" />
            <mat-hint>MM/DD/YYYY</mat-hint>
            <mat-datepicker-toggle matSuffix [for]="datePicker"></mat-datepicker-toggle>
            <mat-datepicker #datePicker></mat-datepicker>
            <mat-error *ngIf="getFieldError('date')">
              {{ getFieldError('date') }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Third Row - Goals -->
        <div class="form-row">
          <mat-form-field class="form-field" appearance="outline">
            <mat-label>Meta de Ahorro (Opcional)</mat-label>
            <input
              matInput
              type="number"
              step="0.01"
              min="0"
              formControlName="goalAmount"
              placeholder="0.00" />
            <span matPrefix>$&nbsp;</span>
            <mat-hint>Establece una meta para este ahorro</mat-hint>
          </mat-form-field>

          <mat-form-field class="form-field" appearance="outline">
            <mat-label>Fecha Objetivo (Opcional)</mat-label>
            <input matInput [matDatepicker]="targetDatePicker" formControlName="targetDate" />
            <mat-hint>Cuándo planeas alcanzar la meta</mat-hint>
            <mat-datepicker-toggle matSuffix [for]="targetDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #targetDatePicker></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button mat-stroked-button type="button" (click)="resetForm()" [disabled]="isLoading">
            <mat-icon>clear</mat-icon>
            Limpiar
          </button>

          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="savingsForm.invalid || isLoading">
            <mat-spinner *ngIf="isLoading" diameter="20" style="margin-right: 10px"></mat-spinner>
            <mat-icon *ngIf="!isLoading">{{ editingId ? 'save' : 'add' }}</mat-icon>
            {{ editingId ? 'Actualizar' : 'Guardar' }} Ahorro
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Savings List -->
  <mat-card class="savings-list-card">
    <mat-card-header>
      <mat-card-title>
        <div class="title-left">
          <mat-icon>list</mat-icon>
          Mis Ahorros
        </div>
        <div class="total-savings" *ngIf="dataSource.data.length > 0">
          Total: ${{ getTotalSavings() | number: '1.2-2' }}
        </div>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Filter -->
      <div class="filter-container" *ngIf="dataSource.data.length > 0">
        <mat-form-field appearance="outline">
          <mat-label>Buscar ahorros</mat-label>
          <input
            matInput
            (keyup)="applyFilter($event)"
            placeholder="Filtrar por descripción o categoría" />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
      </div>

      <!-- Loading -->
      <div class="loading-container" *ngIf="isLoading && dataSource.data.length === 0">
        <mat-spinner diameter="50"></mat-spinner>
      </div>

      <!-- No Data -->
      <div class="no-data-container" *ngIf="!isLoading && dataSource.data.length === 0">
        <mat-icon>savings</mat-icon>
        <h3>No hay ahorros registrados</h3>
        <p>Comienza agregando tu primer ahorro usando el formulario de arriba</p>
        <button mat-raised-button color="primary" (click)="scrollToForm()">
          <mat-icon>add</mat-icon>
          Agregar Ahorro
        </button>
      </div>

      <!-- Savings Table -->
      <div class="table-container" *ngIf="dataSource.data.length > 0">
        <table mat-table [dataSource]="dataSource" class="savings-table" matSort>
          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
            <td mat-cell *matCellDef="let saving">
              {{ saving.date | date: 'dd/MM/yyyy' }}
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Descripción</th>
            <td mat-cell *matCellDef="let saving">
              {{ saving.description }}
            </td>
          </ng-container>

          <!-- Category Column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoría</th>
            <td mat-cell *matCellDef="let saving">
              <div class="category-cell">
                <mat-icon>{{ getCategoryIcon(saving.category) }}</mat-icon>
                {{ getCategoryLabel(saving.category) }}
              </div>
            </td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Monto</th>
            <td mat-cell *matCellDef="let saving">
              <div class="amount-cell">${{ saving.amount | number: '1.2-2' }}</div>
            </td>
          </ng-container>

          <!-- Goal Amount Column -->
          <ng-container matColumnDef="goalAmount">
            <th mat-header-cell *matHeaderCellDef>Meta</th>
            <td mat-cell *matCellDef="let saving">
              <div class="goal-cell" *ngIf="saving.goalAmount">
                ${{ saving.goalAmount | number: '1.2-2' }}
              </div>
              <div class="goal-cell" *ngIf="!saving.goalAmount">Sin meta</div>
            </td>
          </ng-container>

          <!-- Progress Column -->
          <ng-container matColumnDef="progress">
            <th mat-header-cell *matHeaderCellDef>Progreso</th>
            <td mat-cell *matCellDef="let saving">
              <div class="progress-cell" *ngIf="saving.goalAmount">
                <div class="progress-bar">
                  <div
                    class="progress-fill"
                    [class]="getProgressColor(getProgress(saving))"
                    [style.width.%]="getProgress(saving)"></div>
                </div>
                <div class="progress-text">{{ getProgress(saving) | number: '1.0-0' }}%</div>
              </div>
              <div class="progress-cell" *ngIf="!saving.goalAmount">
                <span class="progress-text">Sin meta</span>
              </div>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let saving">
              <div class="action-buttons">
                <button
                  mat-icon-button
                  color="primary"
                  (click)="editSaving(saving)"
                  matTooltip="Editar ahorro">
                  <mat-icon>edit</mat-icon>
                </button>

                <button
                  mat-icon-button
                  color="warn"
                  (click)="deleteSaving(saving.id)"
                  matTooltip="Eliminar ahorro">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>

        <!-- Paginator -->
        <mat-paginator
          [pageSizeOptions]="[5, 10, 20]"
          showFirstLastButtons
          aria-label="Seleccione una página de ahorros"></mat-paginator>
      </div>
    </mat-card-content>
  </mat-card>
</div>
