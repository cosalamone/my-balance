<div class="container-app py-6">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Gestión de Ingresos</h1>
    <p class="text-gray-600">Administra y registra todos tus ingresos mensuales</p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Form Section -->
    <div class="lg:col-span-1">
      <div class="financial-card income-card p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">
          {{ editingId ? 'Editar Ingreso' : 'Nuevo Ingreso' }}
        </h2>

        <form [formGroup]="incomeForm" (ngSubmit)="onSubmit()" class="space-y-4">
          <!-- Amount -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Monto</mat-label>
            <input matInput 
                   type="number" 
                   formControlName="amount"
                   placeholder="0.00">
            <span matPrefix>$&nbsp;</span>
            <mat-error *ngIf="incomeForm.get('amount')?.hasError('required')">
              El monto es requerido
            </mat-error>
            <mat-error *ngIf="incomeForm.get('amount')?.hasError('min')">
              El monto debe ser mayor a 0
            </mat-error>
          </mat-form-field>

          <!-- Description -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Descripción</mat-label>
            <input matInput 
                   formControlName="description"
                   placeholder="Ej: Salario mensual">
            <mat-error *ngIf="incomeForm.get('description')?.hasError('required')">
              La descripción es requerida
            </mat-error>
            <mat-error *ngIf="incomeForm.get('description')?.hasError('minlength')">
              Mínimo 3 caracteres
            </mat-error>
          </mat-form-field>

          <!-- Category -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Categoría</mat-label>
            <mat-select formControlName="category">
              <mat-option *ngFor="let category of incomeCategories" 
                          [value]="category.value">
                {{ category.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Date -->
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>Fecha</mat-label>
            <input matInput 
                   [matDatepicker]="picker" 
                   formControlName="date">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>

          <!-- Recurring -->
          <div class="flex items-center">
            <mat-checkbox formControlName="isRecurring">
              Ingreso recurrente
            </mat-checkbox>
          </div>

          <!-- Actions -->
          <div class="flex gap-3 pt-4">
            <button mat-raised-button 
                    color="primary" 
                    type="submit"
                    [disabled]="!incomeForm.valid || isLoading"
                    class="flex-1">
              <mat-icon *ngIf="isLoading">refresh</mat-icon>
              <span *ngIf="!isLoading">
                {{ editingId ? 'Actualizar' : 'Agregar' }}
              </span>
              <span *ngIf="isLoading">Guardando...</span>
            </button>

            <button mat-button 
                    type="button" 
                    (click)="cancelEdit()"
                    *ngIf="editingId"
                    class="flex-1">
              Cancelar
            </button>
          </div>
        </form>
      </div>

      <!-- Summary Card -->
      <div class="financial-card p-6 mt-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Resumen</h3>
        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Total de Ingresos:</span>
            <span class="font-semibold text-income-600">
              ${{ getTotalIncome() | number:'1.0-0' }}
            </span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Cantidad de Registros:</span>
            <span class="font-semibold text-gray-900">
              {{ dataSource.data.length }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <div class="lg:col-span-2">
      <div class="financial-card p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
          <h2 class="text-xl font-semibold text-gray-900">Historial de Ingresos</h2>
          
          <!-- Search -->
          <mat-form-field appearance="outline" class="w-full sm:w-64">
            <mat-label>Buscar</mat-label>
            <input matInput 
                   (keyup)="applyFilter($event)" 
                   placeholder="Buscar ingresos...">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
          <table mat-table 
                 [dataSource]="dataSource" 
                 matSort 
                 class="w-full">
            
            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
              <td mat-cell *matCellDef="let income">
                {{ income.date | date:'dd/MM/yyyy' }}
              </td>
            </ng-container>

            <!-- Description Column -->
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Descripción</th>
              <td mat-cell *matCellDef="let income">
                <div class="flex flex-col">
                  <span class="font-medium">{{ income.description }}</span>
                  <span class="text-sm text-gray-500" *ngIf="income.isRecurring">
                    <mat-icon class="text-xs">refresh</mat-icon> Recurrente
                  </span>
                </div>
              </td>
            </ng-container>

            <!-- Category Column -->
            <ng-container matColumnDef="category">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Categoría</th>
              <td mat-cell *matCellDef="let income">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-income-100 text-income-800">
                  {{ getCategoryLabel(income.category) }}
                </span>
              </td>
            </ng-container>

            <!-- Amount Column -->
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Monto</th>
              <td mat-cell *matCellDef="let income">
                <span class="font-semibold text-income-600">
                  ${{ income.amount | number:'1.0-0' }}
                </span>
              </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let income">
                <div class="flex gap-2">
                  <button mat-icon-button 
                          color="primary"
                          (click)="editIncome(income)"
                          matTooltip="Editar">
                    <mat-icon>edit</mat-icon>
                  </button>
                  <button mat-icon-button 
                          color="warn"
                          (click)="deleteIncome(income.id)"
                          matTooltip="Eliminar">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>

        <!-- Paginator -->
        <mat-paginator [pageSizeOptions]="[5, 10, 20]"
                       showFirstLastButtons
                       class="mt-4">
        </mat-paginator>

        <!-- No Data -->
        <div *ngIf="dataSource.data.length === 0" 
             class="text-center py-12">
          <mat-icon class="text-6xl text-gray-300 mb-4">inbox</mat-icon>
          <p class="text-gray-500">No hay ingresos registrados</p>
          <p class="text-sm text-gray-400">Comienza agregando tu primer ingreso</p>
        </div>
      </div>
    </div>
  </div>
</div>
